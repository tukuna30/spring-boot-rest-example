version: '1.0'

steps:

  checkoutApp:
    title: 'Cloning a repository...'
    type: git-clone
    repo: tukuna30/spring-boot-rest-example
    revision: blog
    git: github
    
  print_pwd_files:
    title: 'Listing files'
    image: alpine:latest
    commands:
      - 'ls -l'

  mvn_builder:
    type: build
    working_directory: "./spring-boot-rest-example/"
    description: create Maven builder
    dockerfile: Dockerfile.build
    image_name: alexeiled/mvn-builder

  mvn_test:
    working_directory: "./spring-boot-rest-example"
    description: run unit tests 
    image: ${{mvn_builder}}
    commands:
      - mvn -T 1C -o test
  
  mvn_package:
    working_directory: "./spring-boot-rest-example"
    description: package application WAR 
    image: ${{mvn_builder}}
    commands:
      - mvn package -T 1C -o -Dmaven.test.skip=true

  build_image:
    type: build
    description: create Docker image with application WAR
    dockerfile: Dockerfile
    working_directory: "./spring-boot-rest-example/target"
    image_name: alexei-led/sbdemo

  image_push:
    type: push
    description: push to DockerHub
    candidate: '${{build_image}}'
    tag: '${{CF_BRANCH}}'
